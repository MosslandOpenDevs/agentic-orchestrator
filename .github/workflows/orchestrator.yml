name: Orchestrator Schedule

# This workflow runs the orchestrator on a schedule
# Enable by uncommenting the schedule trigger after setup

on:
  # Uncomment to enable scheduled runs
  # schedule:
  #   - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run (step, loop, status)'
        required: true
        default: 'step'
        type: choice
        options:
          - step
          - loop
          - status
      dry_run:
        description: 'Run in dry-run mode'
        required: false
        default: true
        type: boolean
      max_steps:
        description: 'Max steps for loop mode'
        required: false
        default: '10'
        type: string

jobs:
  run-orchestrator:
    runs-on: ubuntu-latest

    # Only run if secrets are configured
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && vars.ORCHESTRATOR_ENABLED == 'true')

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Configure Git
        run: |
          git config user.name "Agentic Orchestrator"
          git config user.email "orchestrator@mossland.org"

      - name: Run Orchestrator
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
        run: |
          COMMAND="${{ inputs.command || 'step' }}"

          if [ "$COMMAND" = "loop" ]; then
            ao loop --max-steps ${{ inputs.max_steps || '10' }}
          elif [ "$COMMAND" = "status" ]; then
            ao status --json
          else
            ao step
          fi

      - name: Push changes
        if: inputs.dry_run != true && inputs.command != 'status'
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "[orchestrator] Automated run - ${{ inputs.command }}"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: orchestrator-output
          path: |
            .agent/state.yaml
            projects/
            alerts/
          retention-days: 7
